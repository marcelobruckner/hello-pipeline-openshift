apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-commit-mainfest
  namespace: hello-pipeline # Certifique-se de usar o namespace correto
  labels:
    app.kubernetes.io/version: "1.0"
  annotations:
    tekton.dev/categories: Deployment
    tekton.dev/tags: kustomize, kubernetes
    tekton.dev/displayName: update-commit-manifest
spec:
  description: >
    Atualiza manifestos Kubernetes com Kustomize, alterando a imagem para um novo SHA ou tag.
    Comita e envia para o GitHub as alteraÃ§Ãµes feitas nos manifestos Kubernetes.

  params:
    - name: GIT_REPO_GITOPS
      description: "URL do repositÃ³rio Git"
      # default: "https://github.com/marcelobruckner/hello-app"

    - name: GIT_BRANCH
      description: "Branch para onde enviar as alteraÃ§Ãµes"
      # default: "main"

    - name: GIT_USER_NAME
      description: "Nome do usuÃ¡rio do Git"
      # default: "Openshift Bot"

    - name: GIT_USER_EMAIL
      description: "E-mail do usuÃ¡rio do Git"

    - name: DIGEST
      description: "SHA da imagem a ser atualizada no Kustomize (ex: sha256:abcd123)"

    - name: IMAGE
      description: "aqui entra o registry. ex: docker.io/marcelobruckner/hello"

    - name: KUSTOMIZE_PATH
      description: "Caminho onde estÃ¡ o kustomization.yaml"
      # default: "."

  workspaces:
    - name: source-gitops
      description: "Workspace contendo os arquivos do Kustomize"

  steps:
    - name: git-clone-repository-gitops
      image: alpine/git:latest
      env:
        - name: HOME
          value: /tekton/home
      envFrom:
        - secretRef:
            name: github-token
      workingDir: $(workspaces.source-gitops.path)
      script: |
        #!/bin/sh
        set -e

        mkdir -p "$HOME"

        if [ -f /tekton/creds/.git-credentials ]; then
          echo "ğŸ” Configurando helper de credenciais do Git a partir de /tekton/creds"
          cp /tekton/creds/.git-credentials "$HOME/.git-credentials"
          git config --global credential.helper "store --file=$HOME/.git-credentials"
        elif [ -n "$username" ] && [ -n "$password" ]; then
          echo "ğŸ” Configurando helper de credenciais usando variÃ¡veis do secret github-token (username/password)"
          printf "https://%s:%s@github.com\n" "$username" "$password" > "$HOME/.git-credentials"
          git config --global credential.helper "store --file=$HOME/.git-credentials"
        elif [ -n "$GIT_USERNAME" ] && [ -n "$GIT_PASSWORD" ]; then
          echo "ğŸ” Configurando helper de credenciais usando variÃ¡veis do secret github-token (GIT_USERNAME/GIT_PASSWORD)"
          printf "https://%s:%s@github.com\n" "$GIT_USERNAME" "$GIT_PASSWORD" > "$HOME/.git-credentials"
          git config --global credential.helper "store --file=$HOME/.git-credentials"
        else
          echo "âš ï¸  Nenhuma credencial encontrada. Verifique o secret github-token e a anotaÃ§Ã£o tekton.dev/git-0."
        fi

        echo "ğŸ”„ Git-clone do repo $(params.GIT_REPO_GITOPS) na branch $(params.GIT_BRANCH)"
        echo "ğŸ“ DiretÃ³rio atual: $(pwd)"

        # ls -la

        if [ -d "repo" ]; then
          echo "ğŸ§¹ DiretÃ³rio 'repo' jÃ¡ existe. Removendo..."
          rm -rf repo
        fi

        git clone $(params.GIT_REPO_GITOPS) -b $(params.GIT_BRANCH) --single-branch --depth 1 repo

    - name: update-manifest-with-kustomize
      image: registry.k8s.io/kustomize/kustomize:v5.0.0
      workingDir: $(workspaces.source-gitops.path)/repo/gitops
      script: |
        #!/bin/sh
        set -e

        echo "ğŸ“‚ DiretÃ³rio atual antes do cd: $(pwd)"
        cd $(workspaces.source-gitops.path)/repo/$(params.KUSTOMIZE_PATH)

        echo "ğŸ“‚ DiretÃ³rio apÃ³s cd: $(pwd)"
        echo "ğŸ” Verificando existÃªncia de kustomization.yaml..."
        ls -la

        echo "ğŸ”„ Atualizando imagem no Kustomize..."
        kustomize edit set image $(params.IMAGE)=$(params.IMAGE):$(params.DIGEST)

        echo "âœ… Kustomization atualizado com sucesso!"
        cat kustomization.yaml

    - name: git-commit-manifest-gitops
      image: alpine/git:latest
      env:
        - name: HOME
          value: /tekton/home
      envFrom:
        - secretRef:
            name: github-token
      workingDir: $(workspaces.source-gitops.path)
      script: |
        #!/bin/sh
        set -e

        mkdir -p "$HOME"

        if [ -f /tekton/creds/.git-credentials ]; then
          echo "ğŸ” Configurando helper de credenciais do Git a partir de /tekton/creds"
          cp /tekton/creds/.git-credentials "$HOME/.git-credentials"
          git config --global credential.helper "store --file=$HOME/.git-credentials"
        elif [ -n "$username" ] && [ -n "$password" ]; then
          echo "ğŸ” Configurando helper de credenciais usando variÃ¡veis do secret github-token (username/password)"
          printf "https://%s:%s@github.com\n" "$username" "$password" > "$HOME/.git-credentials"
          git config --global credential.helper "store --file=$HOME/.git-credentials"
        elif [ -n "$GIT_USERNAME" ] && [ -n "$GIT_PASSWORD" ]; then
          echo "ğŸ” Configurando helper de credenciais usando variÃ¡veis do secret github-token (GIT_USERNAME/GIT_PASSWORD)"
          printf "https://%s:%s@github.com\n" "$GIT_USERNAME" "$GIT_PASSWORD" > "$HOME/.git-credentials"
          git config --global credential.helper "store --file=$HOME/.git-credentials"
        else
          echo "âš ï¸  Nenhuma credencial encontrada. Verifique o secret github-token e a anotaÃ§Ã£o tekton.dev/git-0."
        fi

        echo "ğŸ”§ Configurando Git..."

        echo "ğŸ“‚ DiretÃ³rio atual antes do cd: $(pwd)"
        if [ ! -d "$(workspaces.source-gitops.path)/repo" ]; then
          echo "âŒ DiretÃ³rio do repo nÃ£o encontrado em $(workspaces.source-gitops.path)/repo"
          ls -la $(workspaces.source-gitops.path)
          exit 1
        fi

        cd $(workspaces.source-gitops.path)/repo

        echo "ğŸ“‚ DiretÃ³rio apÃ³s cd: $(pwd)"

        ls -la

        git status
        git config user.name "$(params.GIT_USER_NAME)"
        git config user.email "$(params.GIT_USER_EMAIL)"

        # echo "â• Adicionando alteraÃ§Ãµes..."
        git add .

        # echo "ğŸ“¦ Commitando alteraÃ§Ãµes..."
        git commit -m "Atualiza manifest com nova imagem: $(params.IMAGE)@$(params.DIGEST)" || echo "Nenhuma alteraÃ§Ã£o para commit."

        # echo "ğŸš€ Enviando para o repositÃ³rio remoto..."
        git push origin $(params.GIT_BRANCH)
